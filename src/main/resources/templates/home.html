<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home Page</title>
    <link rel="stylesheet" th:href="@{/home.css}">
</head>
<body>
<div class="container">
    <h1>Welcome to Your Dashboard!</h1>

    <!-- LESSONS -->
    <div class="card">
        <h2>Lessons</h2>
        <a th:href="@{/lessons/create}" class="btn create-lesson">
            ➕ Create Lesson
        </a>

        <div th:if="${homePageData.lessons != null and homePageData.lessons.lessons.size() > 0}">
            <div th:each="lesson : ${homePageData.lessons.lessons}"
                 class="card-content"
                 th:onclick="'openLessonModal(' + ${lesson.id} + ')'"
                 style="cursor:pointer;">
                <strong th:text="${lesson.dateUtc}"></strong><br>

                <span th:if="${lesson.groupName != null}" th:text="${lesson.groupName}"></span>
                <span th:if="${lesson.groupName == null}" th:text="${lesson.studentFullName}"></span>

                <span th:text="${lesson.status}"
                      th:class="'badge badge-' + ${lesson.status.name().toLowerCase()}">
    </span>
            </div>
        </div>
        <p th:if="${homePageData.lessons == null or homePageData.lessons.lessons.size() == 0}">No lessons found.</p>
    </div>

    <!-- HOMEWORKS -->
    <div class="card">
        <h2>Homeworks</h2>
        <div th:if="${homePageData.homeworks != null and homePageData.homeworks.homeworks.size() > 0}">
            <div th:each="homework : ${homePageData.homeworks.homeworks}"
                 class="card-content">
                <span th:text="'Lesson ID: ' + ${homework.lessonId}"></span> /
                <span th:text="${homework.status}"
                      th:class="'badge badge-' + ${homework.status.name().toLowerCase()}">
                </span>
            </div>
        </div>
        <p th:if="${homePageData.homeworks == null or homePageData.homeworks.homeworks.size() == 0}">No homeworks
            found.</p>
    </div>
</div>

<!-- MODAL -->
<div id="lessonModal" class="modal">
    <button onclick="closeModal()" class="close-btn">✖</button>
    <h2>Lesson Info</h2>
    <p><strong>Teacher:</strong> <span id="modal-teacher"></span></p>
    <p><strong>Student:</strong> <span id="modal-student"></span></p>
    <p><strong>Group:</strong> <span id="modal-group"></span></p>
    <p><strong>Status:</strong> <span id="modal-status" class="badge"></span></p>
    <p><strong>Attendance:</strong> <span id="modal-attendance" class="badge"></span></p>

    <label for="attendanceStatusSelect">Attendance Status:</label>
    <select id="attendanceStatusSelect">
        <option value="PLANNED">PLANNED</option>
        <option value="ATTENDED">ATTENDED</option>
        <option value="CANCELLED">CANCELLED</option>
    </select>

    <label for="statusSelect">Update Status:</label>
    <select id="statusSelect">
        <option value="PLANNED">PLANNED</option>
        <option value="COMPLETED">COMPLETED</option>
        <option value="CANCELLED">CANCELLED</option>
    </select>

    <div id="cancelFields" style="margin-top:10px; display:none;">
        <label for="cancelledBySelect">Cancelled By:</label>
        <select id="cancelledBySelect">
            <option value="TEACHER">TEACHER</option>
            <option value="STUDENT">STUDENT</option>
        </select>

        <label for="cancelReasonSelect">Reason:</label>
        <select id="cancelReasonSelect">
            <option value="VALID_REASON">VALID_REASON</option>
            <option value="INVALID_REASON">INVALID_REASON</option>
        </select>
    </div>

    <button onclick="updateLesson()" style="margin-top:10px;">Update</button>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>

<!-- JS -->
<script>
    let selectedLessonId = null;

    function openLessonModal(lessonId) {
        fetch(`/lessons/api/lesson?id=${lessonId}`)
            .then(res => res.json())
            .then(data => {
                selectedLessonId = data.id;
                document.getElementById("modal-teacher").textContent = data.teacherName || "–";
                document.getElementById("modal-student").textContent = data.studentName || "–";
                document.getElementById("modal-group").textContent = data.groupName || "–";

                const statusElem = document.getElementById("modal-status");
                statusElem.textContent = data.status;
                statusElem.className = "badge badge-" + data.status.toLowerCase();

                const attendanceElem = document.getElementById("modal-attendance");
                attendanceElem.textContent = data.attendanceStatus;
                attendanceElem.className = "badge badge-" + data.attendanceStatus.toLowerCase();

                document.getElementById("attendanceStatusSelect").value = data.attendanceStatus || "PLANNED";
                document.getElementById("statusSelect").value = data.status || "PLANNED";
                document.getElementById("cancelledBySelect").value = data.cancelledBy || "TEACHER";
                document.getElementById("cancelReasonSelect").value = data.cancelingReason || "VALID_REASON";
                toggleCancelFields(data.status === "CANCELLED");

                document.getElementById("lessonModal").style.display = "block";
                document.getElementById("modalOverlay").style.display = "block";
            });
    }

    function closeModal() {
        document.getElementById("lessonModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
    }

    function toggleCancelFields(show) {
        document.getElementById("cancelFields").style.display = show ? "block" : "none";
    }

    document.getElementById("statusSelect").addEventListener("change", function () {
        toggleCancelFields(this.value === "CANCELLED");
    });

    function updateLesson() {
        const status = document.getElementById("statusSelect").value;
        const payload = {
            lessonId: selectedLessonId,
            status: status,
            attendanceStatus: document.getElementById("attendanceStatusSelect").value
        };

        if (status === "CANCELLED") {
            payload.cancelledBy = document.getElementById("cancelledBySelect").value;
            payload.cancelingReason = document.getElementById("cancelReasonSelect").value;
        }

        fetch("/lessons/api/lesson/update", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        }).then(() => {
            closeModal();
            location.reload();
        });
    }
</script>
</body>
</html>
