<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home Page</title>
    <link rel="stylesheet" th:href="@{/home.css}">
</head>
<body>

<div class="container">
    <h1>Welcome to Your Dashboard!</h1>

    <div class="card" style="margin-bottom: 20px;">
        <h2>Lessons</h2>
        <a th:href="@{/lessons/create}" class="btn">+ Create Lesson</a>

        <div th:if="${homePageData.lessons != null and homePageData.lessons.lessons.size() > 0}">
            <div th:each="lesson : ${homePageData.lessons.lessons}"
                 class="card-content"
                 th:onclick="'openLessonModal(' + ${lesson.id} + ')'"
                 style="cursor:pointer;">
                <strong th:text="${lesson.dateUtc}"></strong><br>
                <span th:text="${lesson.teacherFullName}"></span> /
                <span th:text="${lesson.studentFullName}"></span> /
                <span th:text="${lesson.groupName}"></span> /
                <em th:text="${lesson.status}"></em>
            </div>
        </div>
        <p th:if="${homePageData.lessons == null or homePageData.lessons.lessons.size() == 0}">No lessons found.</p>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>Homeworks</h2>
        <div th:if="${homePageData.homeworks != null and homePageData.homeworks.homeworks.size() > 0}">
            <div th:each="homework : ${homePageData.homeworks.homeworks}" class="card-content">
                <span th:text="'Lesson ID: ' + ${homework.lessonId}"></span> /
                <em th:text="${homework.status}"></em>
            </div>
        </div>
        <p th:if="${homePageData.homeworks == null or homePageData.homeworks.homeworks.size() == 0}">No homeworks found.</p>
    </div>

    <div class="card" th:if="${homePageData.studentGroup != null}" style="margin-bottom: 20px;">
        <h2>My Group</h2>
        <p th:text="${homePageData.studentGroup.name}"></p>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>My Students</h2>
        <div th:if="${homePageData.teacherStudents != null and homePageData.teacherStudents.size() > 0}">
            <ul>
                <li th:each="student : ${homePageData.teacherStudents}" th:text="${student.firstName + ' ' + student.lastName}"></li>
            </ul>
        </div>
        <p th:if="${homePageData.teacherStudents == null or homePageData.teacherStudents.size() == 0}">No students found.</p>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>My Groups</h2>
        <div th:if="${homePageData.teacherGroups != null and homePageData.teacherGroups.size() > 0}">
            <ul>
                <li th:each="group : ${homePageData.teacherGroups}" th:text="${group.name}"></li>
            </ul>
        </div>
        <p th:if="${homePageData.teacherGroups == null or homePageData.teacherGroups.size() == 0}">No groups found.</p>
    </div>
</div>

<!-- Lesson Modal -->
<div id="lessonModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000">
    <button onclick="closeModal()" style="float:right;">✖</button>
    <h2>Lesson Info</h2>
    <p><strong>Teacher:</strong> <span id="modal-teacher"></span></p>
    <p><strong>Student:</strong> <span id="modal-student"></span></p>
    <p><strong>Group:</strong> <span id="modal-group"></span></p>
    <p><strong>Status:</strong> <span id="modal-status"></span></p>

    <p><strong>Attendance Status:</strong> <span id="modal-attendance-status"></span></p>

    <label for="attendanceStatusSelect">Update Attendance Status:</label>
    <select id="attendanceStatusSelect">
        <option value="PLANNED">PLANNED</option>
        <option value="ATTENDED">ATTENDED</option>
        <option value="CANCELLED">CANCELLED</option>
    </select>

    <label for="statusSelect">Update Status:</label>
    <select id="statusSelect">
        <option value="PLANNED">PLANNED</option>
        <option value="COMPLETED">COMPLETED</option>
        <option value="CANCELLED">CANCELLED</option>
    </select>

    <div id="cancelFields" style="margin-top:10px; display:none;">
        <label for="cancelledBySelect">Cancelled By:</label>
        <select id="cancelledBySelect">
            <option value="TEACHER">TEACHER</option>
            <option value="STUDENT">STUDENT</option>
        </select>

        <label for="cancelReasonSelect">Reason:</label>
        <select id="cancelReasonSelect">
            <option value="VALID_REASON">VALID_REASON</option>
            <option value="INVALID_REASON">INVALID_REASON</option>
        </select>
    </div>

    <button onclick="updateLesson()" style="margin-top:10px;">Update</button>
</div>

<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;" onclick="closeModal()"></div>

<script>
    let selectedLessonId = null;

    function openLessonModal(lessonId) {
        fetch(`/lessons/api/lesson?id=${lessonId}`)
            .then(res => res.json())
            .then(data => {
                selectedLessonId = data.id;
                document.getElementById("modal-attendance-status").textContent = data.attendanceStatus || "–";
                document.getElementById("modal-teacher").textContent = data.teacherName || "–";
                document.getElementById("modal-student").textContent = data.studentName || "–";
                document.getElementById("modal-group").textContent = data.groupName || "–";
                document.getElementById("modal-status").textContent = data.status || "–";
                document.getElementById("attendanceStatusSelect").value = data.attendanceStatus || "PLANNED";
                document.getElementById("statusSelect").value = data.status || "PLANNED";
                document.getElementById("cancelledBySelect").value = data.cancelledBy || "TEACHER";
                document.getElementById("cancelReasonSelect").value = data.cancelingReason || "VALID_REASON";
                toggleCancelFields(data.status === "CANCELLED");

                document.getElementById("lessonModal").style.display = "block";
                document.getElementById("modalOverlay").style.display = "block";
            });
    }

    function closeModal() {
        document.getElementById("lessonModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
    }

    function toggleCancelFields(show) {
        document.getElementById("cancelFields").style.display = show ? "block" : "none";
    }

    document.getElementById("statusSelect").addEventListener("change", function () {
        toggleCancelFields(this.value === "CANCELLED");
    });

    function updateLesson() {
        const status = document.getElementById("statusSelect").value;
        const attendanceStatus = document.getElementById("attendanceStatusSelect").value;

        const payload = {
            lessonId: selectedLessonId,
            status: status,
            attendanceStatus: attendanceStatus
        };

        if (status === "CANCELLED") {
            payload.cancelledBy = document.getElementById("cancelledBySelect").value;
            payload.cancelingReason = document.getElementById("cancelReasonSelect").value;
        }

        fetch("/lessons/api/lesson/update", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        }).then(() => {
            closeModal();
            location.reload();
        });
    }
</script>

</body>
</html>